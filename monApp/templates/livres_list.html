{% extends 'base.html' %}

{% block main %}

  <div class="container mt-4">
    <h1 class="text-center mb-4">Catalogue des livres</h1>
    <p class="text-muted text-center">Nombre de livres : <strong>{{ livres|length }}</strong></p>

{% if livres|length == 0 %}
  <p class="alert alert-warning text-center">Aucun livre trouvé.</p>
{% endif %}

<form id="search-form" method="get" action="{{ url_for('getLivres') }}" 
      class="d-flex justify-content-center mb-4">
  <input type="text" id="search-input" name="q" class="form-control w-50 me-2 rounded-pill shadow-sm" 
         placeholder="🔍 Rechercher un livre..." value="{{ query }}">
  <input type="hidden" name="sort" value="{{ sort_by }}">
  <button type="submit" class="btn btn-primary rounded-pill">Rechercher</button>
</form>

<div class="d-flex justify-content-center mb-3 gap-2">
  <a href="{{ url_for('getLivres', q=query, sort='titre') }}" 
     class="btn btn-sm {% if sort_by == 'titre' %}btn-primary{% else %}btn-outline-primary{% endif %}">
    Trier par titre
  </a>
  <a href="{{ url_for('getLivres', q=query, sort='prix_asc') }}" 
     class="btn btn-sm {% if sort_by == 'prix_asc' %}btn-primary{% else %}btn-outline-primary{% endif %}">
    Prix ↑
  </a>
  <a href="{{ url_for('getLivres', q=query, sort='prix_desc') }}" 
     class="btn btn-sm {% if sort_by == 'prix_desc' %}btn-primary{% else %}btn-outline-primary{% endif %}">
    Prix ↓
  </a>
</div>

<div id="results" class="row g-4">
  {% for unLivre in livres %}
    <div class="col-6 col-md-4 col-lg-3 col-xl-2">
      <div class="card h-100 d-flex flex-column shadow-sm border-0 position-relative">
        
        {% if current_user.is_authenticated %}
        <button class="btn btn-link position-absolute top-0 end-0 p-2 favori-btn" 
                data-livre-id="{{ unLivre.idL }}"
                style="z-index: 10; font-size: 1.5rem; text-decoration: none;">
          {% if current_user.est_favori(unLivre) %}
            ⭐
          {% else %}
            ☆
          {% endif %}
        </button>
        {% endif %}
        
        <a href="{{ url_for('viewLivre', idL=unLivre.idL) }}" class="text-decoration-none text-dark">
          <div class="d-flex justify-content-center p-3">
            <img src="{{ url_for('static', filename='images/' + unLivre.img) }}" 
                 alt="Couverture du livre {{ unLivre.titre }}" 
                 class="img-fluid rounded shadow-sm" 
                 style="max-height: 250px; object-fit: cover;">
          </div>

          <div class="card-body text-center">
            <h6 class="card-title fw-bold text-truncate" title="{{ unLivre.titre }}">
              {{ unLivre.titre }}
            </h6>
            <p class="text-muted mb-1">✍️ {{ unLivre.auteur.Nom }}</p>
            <p class="text-danger fw-bold mb-3">💰 {{ "%.2f"|format(unLivre.prix) }} €</p>
          </div>
        </a>

        <div class="mt-auto card-footer bg-white text-center border-0 pb-3">
          <a href="{{ unLivre.url }}" target="_blank"
             class="btn btn-success w-100 fw-bold">
             🛒 Acheter
          </a>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

  </div>

  <script src="{{ url_for('static', filename='js/search_livres.js') }}"></script>
  <script src="{{ url_for('static', filename='js/favoris.js') }}"></script>

{% endblock %}